<!DOCTYPE html>
<html lang="en">
 <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Jubal test</title>
    <script type="text/javascript" src="Jubal.js"></script>
    <script type="text/javascript" src="https://cindyjs.org/dist/v0.8/Cindy.js"></script>
    <script type="text/javascript" src="https://cindyjs.org/dist/v0.8/CindyGL.js"></script>
    <script type="text/javascript" src="cindyLoader.js"></script>

  </head>

<body style="font-family:Palatino; margin:0; font-size:16pt">

<script id='csinit' type='text/x-cindyscript'>
drawContext() := (
  regional(entries, entryGrid, hStep, vStep);

  hStep = 5;
  vStep = 1.5;
  tl = canvasCorners.tl + [15, -4];
  entries = apply(contextIncidences, row, apply(row, if(# == 1, unicode("2717"), "")));
  entryGrid = grid(tl, g, m, vStep, hStep);
  
  forall(1..g, i, forall(1..m, j,
    drawtext(entryGrid_i_j, entries_i_j, size -> 20, align -> "mid");
  ));
  forall(1..g,
    drawtext(tl + [-4, -(# - 1) * vStep], objectNames_#, size -> 20, align -> "right");
  );
  forall(1..m,
    drawtext(tl + [(# - 1) * hStep, 2], attributeNames_#, size -> 20, align -> "mid");
  );
);

grid(tl, vNumber, hNumber, vStep, hStep) := (
  regional(i, j);

  apply(1..vNumber, j,
    apply(1..hNumber, i,
      tl + [(i - 1) * hStep, -(j - 1) * vStep];
    );
  );
);

drawConceptLattice() := (
  regional(n, inBetweenNode);

  n = length(latticeExtents);

  forall(1..n, i, forall(1..n, j,
    if(latticeNeighbors_i_j == 1,
      draw(latticeCoordinates_i, latticeCoordinates_j)
    );
  ));
  forall(1..n, i,
    draw(latticeCoordinates_i);
    drawtext(latticeCoordinates_i + 0.3 * [-0.5, 0.3], objectNamesShort_(select(1..g, latticeExtents_i_# == 1)), align -> "right");
    drawtext(latticeCoordinates_i + 0.3 * [0.5, -0.3], attributeNamesShort_(select(1..m, latticeIntents_i_# == 1)), align -> "left");
  );
);

initilizeLatticeCoordinates() := (
  regional(n, minSize, maxSize);
  n = length(latticeExtents);

  minSize = min(apply(latticeExtents, sum(#)));
  maxSize = max(apply(latticeExtents, sum(#)));

  latticeCoordinates = apply(1..n,
    [lerp(canvasCenter.x - 8, canvasCenter.x + 8, #, 1, n), lerp(lowerLimit, upperLimit, sum(latticeExtents_#), minSize, maxSize)];
  );
);

updateLatticeCoordinates(delta) := (
  regional(n);

  n = length(latticeExtents);

  // This is so wrong, LMAO!
  latticeCoordinates = transpose(latticeCoordinates);
  latticeCoordinates_1 = forceMatrix * latticeCoordinates_1 * delta + latticeCoordinates_1;
  latticeCoordinates = transpose(latticeCoordinates);

  forall(1..n,
    latticeCoordinates_# = [clamp(latticeCoordinates_#_1, leftLimit, rightLimit), clamp(latticeCoordinates_#_2, lowerLimit, upperLimit)];
  );
);

updateForceMatrix() := (
  regional(n, distanceMatrix, inverseDistanceMatrix);

  n = length(latticeExtents);

  distanceMatrix = apply(1..n, i, apply(1..n, j,
      dist(latticeCoordinates_i, latticeCoordinates_j);
    ));
  inverseDistanceMatrix = apply(1..n, i, apply(1..n, j,
      if(i == j, 0, 
        if(distanceMatrix_i_j ~= 0, 1000, 1 / distanceMatrix_i_j^2);
      );
    ));

  forceMatrix = apply(1..n, i, apply(1..n, j, if(i == j, sum(inverseDistanceMatrix_i), -inverseDistanceMatrix_i_j))) * 0.3
             + (apply(1..n, i, apply(1..n, j, if(latticeNeighbors_i_j == 1, distanceMatrix_i_j, 0))) - apply(1..n, i, apply(1..n, j, if(i == j, sum(distanceMatrix_i), 0)))) * 0.03;
);

// ******************************************************************************************

g = 7;
m = 5;

objectNames = ["Toyota Supra", "Nissan Skyline", "Mitsubishi Eclipse", "Mitsubishi Lancer Evolution", "Mazda RX-7", "Honda S2000", "Chevrolet Impala"];
objectNamesShort = ["ts", "ns", "me", "mle", "mrx7", "hs", "ci"];
attributeNames = ["Is white", "before 1980", "Japanese", "5 doors", "has sunroof"];
attributeNamesShort = ["w", "80", "j", "5", "s"];

contextIncidences = [];

latticeExtents = [];
latticeIntents = [];
latticeIncidences = [];
latticeNeighbors = [];
latticeCoordinates = [];
forceMatrix = [];


upperLimit = canvasTop - 3;
lowerLimit = canvasBottom + 3;
leftLimit = canvasLeft + 3;
rightLimit = canvasRight - 3;


switchedToLattice = false;

test = [];

javascript("createCarContext()");

setupTime();
playanimation();
</script>

<script id='csdraw' type='text/x-cindyscript'>
if(switchedToLattice,
  drawConceptLattice();
, // else //
  drawContext();
);
</script>

<script id='cstick' type='text/x-cindyscript'>
delta = deltaTime();

if(switchedToLattice,
  updateLatticeCoordinates(delta);
);
</script>

<script id='csmousemove' type='text/x-cindyscript'>
</script>

<script id='csmousedown' type='text/x-cindyscript'>
if(not(switchedToLattice),
  switchedToLattice = true;
  javascript("computeLattice()");
, // else //
  switchedToLattice = false;
  
  contextIncidences = [];

  latticeExtents = [];
  latticeIntents = [];
  latticeIncidences = [];
  latticeNeighbors = [];
  latticeCoordinates = [];
  forceMatrix = [];


  javascript("createCarContext()");
);
</script>

<script id='csmousedrag' type='text/x-cindyscript'>
</script>

<script id='csmouseup' type='text/x-cindyscript'>
</script>

<canvas id="CSCanvas" align="left" valign="top" width="1024" height="768" style="border:1px solid #000000;"></canvas>



    
<script>


fetch("egdod.cjs")
	.then(response => response.text())
	.then(data => {
		loadCindyScript(data);
		cindy = startCindy({
    canvasname:"CSCanvas",
      scripts:"cs*",
      images: {},
      use: ["katex"],
  });
});

  
var context;

function createContext(g, m) {
  
  context = new Context(m);
  for(var i = 0; i < g; i++) {
    let atts = [];
    for(var j = 0; j < m; j++) {
      atts.push(Math.round(Math.random()));
    }
    context.addObject(atts);
  }
  cindy.evokeCS('contextIncidences = ' + JSON.stringify(context.incidences) + ';');
  
}

function createCarContext() {
  context = new Context(5);
  context.addObject([1, 1, 1, 0, 1]);
  context.addObject([1, 1, 1, 1, 0]);
  context.addObject([0, 0, 1, 0, 0]);
  context.addObject([0, 0, 1, 1, 0]);
  context.addObject([1, 1, 1, 0, 0]);
  context.addObject([0, 0, 1, 0, 1]);
  context.addObject([0, 1, 0, 1, 0]);

  cindy.evokeCS('contextIncidences = ' + JSON.stringify(context.incidences) + ';');
}

function computeLattice() {
  timeA = new Date().getTime();
  lattice = new conceptLattice(context);
  timeB = new Date().getTime();
  console.log("Time for extents: " + (timeB - timeA) + "ms");

  timeC = new Date().getTime();
  
  
  let command = 'latticeExtents = ' + JSON.stringify(lattice.extents) + ';' 
              + 'latticeIntents = ' + JSON.stringify(lattice.intents) + ';' 
              + 'latticeIncidences = ' + JSON.stringify(lattice.incidences) + ';' 
              + 'latticeNeighbors = ' + JSON.stringify(lattice.neighbors) + ';'
              + 'initilizeLatticeCoordinates(); updateForceMatrix();';
  cindy.evokeCS(command);
  
  
 //cindy.evokeCS('lattice = ' + JSON.stringify(lattice) + ';');

  timeD = new Date().getTime();
  console.log("Time for tranfering data: " + (timeD - timeC) + "ms");
}

</script>








</body>

</html>
