<!DOCTYPE html>
<html lang="en">
 <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Jubal test</title>
    <script type="text/javascript" src="Jubal.js"></script>
    <script type="text/javascript" src="https://cindyjs.org/dist/v0.8/Cindy.js"></script>
    <script type="text/javascript" src="https://cindyjs.org/dist/v0.8/CindyGL.js"></script>
    <script type="text/javascript" src="cindyLoader.js"></script>

  </head>

<body style="font-family:Palatino; margin:0; font-size:16pt">

<script id='csinit' type='text/x-cindyscript'>
drawContext() := (
  regional(entries);

  linecolor((0,0,0));
  entries = apply(contextIncidences, row, apply(row, if(# == 1, unicode("2717"), "")));
  drawtable([leftLimit, lowerLimit], entries, align -> "mid", width -> 30);
);

drawConceptLattice() := (
  regional(n, minSize, maxSize, inBetweenNode);

  n = length(latticeExtents);
  minSize = min(apply(latticeExtents, sum(#)));
  maxSize = max(apply(latticeExtents, sum(#)));

  coordinates = apply(1..n,
    [lerp(canvasCenter.x - 10, canvasCenter.x + 10, #, 1, n), lerp(lowerLimit, upperLimit, sum(latticeExtents_#), minSize, maxSize)];
  );
  forall(1..n, i, forall(1..n, j,
    if(latticeNeighbors_i_j == 1,
      draw(coordinates_i, coordinates_j)
    );
  ));
  forall(1..n,
    draw(coordinates_#);
    //drawtext(coordinates_# + 0.3 * [-0.5, 0.3], objectNames_(latticeExtents_#), align -> "right");
    //drawtext(coordinates_# + 0.3 * [0.5, -0.3], attributeNames_(latticeIntents_#), align -> "left");
  );
);

// ******************************************************************************************

g = 15;
m = 6;

objectNames = 1..g;
attributeNames = 1..m;

contextIncidences = [];

latticeExtents = [];
latticeIntents = [];
latticeIncidences = [];
latticeNeighbors = [];

upperLimit = canvasTop - 3;
lowerLimit = canvasBottom + 3;
leftLimit = canvasLeft + 3;
rightLimit = canvasRight - 3;


switchedToLattice = false;

test = [];

javascript("createContext(" + g + ", " + m + ")");
</script>

<script id='csdraw' type='text/x-cindyscript'>
if(switchedToLattice,
  drawConceptLattice();
, // else //
  drawContext();
);
</script>

<script id='cstick' type='text/x-cindyscript'>
</script>

<script id='csmousemove' type='text/x-cindyscript'>
</script>

<script id='csmousedown' type='text/x-cindyscript'>
if(not(switchedToLattice),
  switchedToLattice = true;
  javascript("computeLattice()");
, // else //
  switchedToLattice = false;
  
  contextIncidences = [];

  latticeExtents = [];
  latticeIntents = [];
  latticeIncidences = [];
  latticeNeighbors = [];

  javascript("createContext(" + g + ", " + m + ")");
);
</script>

<script id='csmousedrag' type='text/x-cindyscript'>
</script>

<script id='csmouseup' type='text/x-cindyscript'>
</script>

<canvas id="CSCanvas" align="left" valign="top" width="800" height="600" style="border:1px solid #000000;"></canvas>



    
<script>


fetch("egdod.cjs")
	.then(response => response.text())
	.then(data => {
		loadCindyScript(data);
		cindy = startCindy({
    canvasname:"CSCanvas",
      scripts:"cs*",
      images: {},
      use: ["katex"],
  });
});

  
var context;

function createContext(g, m) {
  
  context = new Context(m);
  for(var i = 0; i < g; i++) {
    let atts = [];
    for(var j = 0; j < m; j++) {
      atts.push(Math.round(Math.random()));
    }
    context.addObject(atts);
  }
  cindy.evokeCS('contextIncidences = ' + JSON.stringify(context.incidences) + ';');
  
}

function computeLattice() {
  timeA = new Date().getTime();
  lattice = new conceptLattice(context);
  timeB = new Date().getTime();
  console.log("Time for extents: " + (timeB - timeA) + "ms");

  timeC = new Date().getTime();
  
  
  let command = 'latticeExtents = ' + JSON.stringify(lattice.extents) + ';' 
              + 'latticeIntents = ' + JSON.stringify(lattice.intents) + ';' 
              + 'latticeIncidences = ' + JSON.stringify(lattice.incidences) + ';' 
              + 'latticeNeighbors = ' + JSON.stringify(lattice.neighbors) + ';';
  cindy.evokeCS(command);
  
  
 //cindy.evokeCS('lattice = ' + JSON.stringify(lattice) + ';');

  timeD = new Date().getTime();
  console.log("Time for tranfering data: " + (timeD - timeC) + "ms");
}

</script>








</body>

</html>
