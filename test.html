<!DOCTYPE html>
<html lang="en">
 <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Jubal test</title>
    <script type="text/javascript" src="Jubal.js"></script>
    <script type="text/javascript" src="https://cindyjs.org/dist/v0.8/Cindy.js"></script>
    <script type="text/javascript" src="https://cindyjs.org/dist/v0.8/CindyGL.js"></script>
    <script type="text/javascript" src="cindyLoader.js"></script>

  </head>

<body style="font-family:Palatino; margin:0; font-size:16pt">

<script id='csinit' type='text/x-cindyscript'>
drawContext(ctx) := (
  regional(entries);

  linecolor((0,0,0));
  entries = apply(ctx.incidences, row, apply(row, if(# == 1, unicode("2717"), "")));
  drawtable([leftLimit, lowerLimit], entries, align -> "mid", width -> 30);
);

drawConceptLattice(lat) := (
  regional(n, minSize, maxSize, inBetweenNode);

  n = length(lat.nodes);
  minSize = min(apply(lat.nodes, length(#_1)));
  maxSize = max(apply(lat.nodes, length(#_1)));

  coordinates = apply(1..n,
    [lerp(canvasCenter.x - 10, canvasCenter.x + 10, #, 1, n), lerp(lowerLimit, upperLimit, length(lat.nodes_#_1), minSize, maxSize)];
  );
  forall(1..n, i, forall(1..n, j,
    if(lattice.neighbors_i_j == 1,
      draw(coordinates_i, coordinates_j)
    );
  ));
  forall(1..n,
    draw(coordinates_#);
    //drawtext(coordinates_# + 0.3 * [-0.5, 0.3], lat.objectNames_(lat.nodes_#_1), align -> "right");
    //drawtext(coordinates_# + 0.3 * [0.5, -0.3], lat.attributeNames_(lat.nodes_#_2), align -> "left");
  );
);

// ******************************************************************************************

g = 15;
m = 6;

context = {
  "objectNames": 1..6,
  "attributeNames": 1..m,
  "incidences": []
};

lattice = {
  "objectNames": 1..6,
  "attributeNames": 1..m,
  "nodes": [],
  "incidences": [],
  "neighbors": []
};

upperLimit = canvasTop - 3;
lowerLimit = canvasBottom + 3;
leftLimit = canvasLeft + 3;
rightLimit = canvasRight - 3;


switchedToLattice = false;


javascript("createContext(" + g + ", " + m + ")");
</script>

<script id='csdraw' type='text/x-cindyscript'>
if(switchedToLattice,
  drawConceptLattice(lattice);
, // else //
  drawContext(context);
);
</script>

<script id='cstick' type='text/x-cindyscript'>
</script>

<script id='csmousemove' type='text/x-cindyscript'>
</script>

<script id='csmousedown' type='text/x-cindyscript'>
if(not(switchedToLattice),
  switchedToLattice = true;
  javascript("computeLattice()");
, // else //
  switchedToLattice = false;
  context = {
    "objectNames": 1..6,
    "attributeNames": 1..m,
    "incidences": []
  };

  lattice = {
    "objectNames": 1..6,
    "attributeNames": 1..m,
    "nodes": [],
    "incidences": [],
    "neighbors": []
  };
  javascript("createContext(" + g + ", " + m + ")");
);
</script>

<script id='csmousedrag' type='text/x-cindyscript'>
</script>

<script id='csmouseup' type='text/x-cindyscript'>
</script>

<canvas id="CSCanvas" align="left" valign="top" width="800" height="600" style="border:1px solid #000000;"></canvas>



    
<script>


fetch("egdod.cjs")
	.then(response => response.text())
	.then(data => {
		loadCindyScript(data);
		cindy = startCindy({
    canvasname:"CSCanvas",
      scripts:"cs*",
      images: {},
      use: ["katex"],
  });
});

  
var context;

function createContext(g, m) {
  
  context = new Context(m);
  for(var i = 0; i < g; i++) {
    let atts = [];
    for(var j = 0; j < m; j++) {
      atts.push(Math.round(Math.random()));
    }
    context.addObject(atts);
  }

  for(let row of context.incidences) {
    cindy.evokeCS('context.incidences = context.incidences :> [];');
    for(let entry of row) {
      cindy.evokeCS('context.incidences_(-1) = context.incidences_(-1) :> ' + entry + ';');
    }
  }
}

function computeLattice() {
  time = new Date().getTime();
  lattice = new conceptLattice(context);
  time = new Date().getTime() - time;
  console.log(time);

  for(let node of lattice.nodes) {
    cindy.evokeCS('lattice.nodes = lattice.nodes :> [[], []];');
    for(let entry of node.extent) {
      cindy.evokeCS('lattice.nodes_(-1)_1 = lattice.nodes_(-1)_1 :> ' + (entry + 1) + ';');
    }
    for(let entry of node.intent) {
      cindy.evokeCS('lattice.nodes_(-1)_2 = lattice.nodes_(-1)_2 :> ' + (entry + 1) + ';');
    }
  }
  for(let row of lattice.incidences) {
    cindy.evokeCS('lattice.incidences = lattice.incidences :> [];');
    for(entry of row) {
      cindy.evokeCS('lattice.incidences_(-1) = lattice.incidences_(-1) :> ' + entry + ';');
    }
  }
  for(let row of lattice.neighbors) {
    cindy.evokeCS('lattice.neighbors = lattice.neighbors :> [];');
    for(entry of row) {
      cindy.evokeCS('lattice.neighbors_(-1) = lattice.neighbors_(-1) :> ' + entry + ';');
    }
  }
}

</script>








</body>

</html>
